# 外部实验详情查看器 - 需求文档

## 1. 背景与目标
- **背景**: 现有管理平台掌握多门课程的实验数据，希望接入“本课程实验”，通过平台传递 URL（含实验标识与用户信息等）直接跳转到本系统，展示指定实验的完整详情。
- **目标**: 提供一个可对外链路访问的“单页实验详情”应用（或静态页面），支持通过 `sessionId`（或兼容 `SessionId`、`_id`、`externalId`）拉取实验详情并可视化展示；接口不可用时支持示例数据回退展示。
- **非目标**: 不含账号体系、复杂路由与后台管理；不含数据编辑；不负责上游平台生成签名链接（可选项见“安全”）。

## 2. 最小可用范围（MVP）
- 单个页面：实验详情可视化（基础信息 + 表情统计 + 对话记录）。
- 入口参数：URL 查询参数 `sessionId`（字符串）。
- 数据来源：
  - 优先：后端接口 `GET /api/experiments/external/:id`（公网可访问、支持 CORS）
  - 回退：页面内置示例数据（用于接口不可达或联调前演示）
- 部署形态：
  - 前端：静态资源（可放 Nginx/CDN/任何静态托管）
  - 后端：已有或新建 API，对外开放 `/api/experiments/external/:id`

## 3. 数据结构（标准化视图）
后端应返回标准化字段，兼容历史大小写写法：
- `sessionId`: 来自 `sessionId` 或 `SessionId`
- `userId`: 来自 `userId` 或 `UserId`
- `smilePercentage`: 来自 `smilePercentage` 或 `SmilePercentage`
- `neutralPercentage`: 来自 `neutralPercentage` 或 `NeutralPercentage`
- `surprisedPercentage`: 来自 `surprisedPercentage` 或 `SurprisedPercentage`
- `totalExpressionCount`: 来自 `totalExpressionCount` 或 `TotalExpressionCount`
- `sessionName`（可选）
- `chatMessages`: 数组（`speaker`, `message`, `timestamp`, `messageType`）
- `createdAt` / `updatedAt` / `startTime` / `endTime`（任一可用于展示时间）
- `metadata`（可选对象）/ `source`（可选）/ `serverInfo`（可选）

示例：
```json
{
  "success": true,
  "data": {
    "_id": "685df5cc14155de914b91550",
    "sessionId": "D615030F4886915F8327D59DD37C30FE",
    "userId": "136cf93a47d49c15fdd34ebdd9fc162c",
    "sessionName": "Complete Session",
    "smilePercentage": 70.21138,
    "neutralPercentage": 1.07317,
    "surprisedPercentage": 28.71545,
    "totalExpressionCount": 3075,
    "chatMessages": [
      { "speaker": "李老师", "message": "你这边啥情况？ 小孩子磕着了。", "timestamp": "2025.06.27-09.37.14" }
    ],
    "createdAt": "2025-06-27T01:37:16.335Z",
    "metadata": { "dataType": "completeSession" },
    "source": "UE5",
    "serverInfo": { "environment": "production" }
  }
}
```

## 4. 接口约定（后端）
- 路径：`GET /api/experiments/external/:id`
- 鉴权：MVP 可公开（无鉴权）；若需安全，见“安全”章节。
- 跨域：必须允许前端域名（CORS）。
- 成功返回：见“数据结构”示例。
- 失败返回：
```json
{ "success": false, "message": "未找到实验" }
```
- 兼容映射：后端在组装响应时需做大小写字段兼容（SessionId/SmilePercentage 等）。

## 5. 页面与交互（前端）
- 页面路由：
  - 独立静态页：`/simple-experiment/index.html?sessionId=...`
  - 或新项目的根路由：`/` 接收 `sessionId` 查询参数
- 结构：
  1) 头部：标题 + 副标题/来源信息
  2) 基础信息：`sessionId`、`userId`、`sessionName`、`createdAt`
  3) 表情统计：三条进度条（微笑/中性/惊讶），显示百分比与 `totalExpressionCount`
  4) 对话记录：按时间顺序展示 `chatMessages`，支持换行与长文
- 异常与回退：
  - 当接口返回非 2xx 或 `success=false`，显示顶部提示，自动使用内置示例数据渲染
  - 任何字段缺省时用 `-` 占位
- 视觉：简洁卡片式；移动端一列、桌面端两列自适应

## 6. 安全（可选增强）
- 深链签名：上游平台生成 URL 参数 `ts`/`sig`，你方校验：
  - `sig = HMAC_SHA256(EXTERNAL_LINK_SECRET, expId|userId|classId|ts)`
  - 链接有效期：5 分钟
- 短期令牌：通过解析接口发放 5 分钟 JWT，前端携带访问
- 防重放：对 `(expId, ts)` 做一次性校验（内存/Redis）
- 仅当对外安全有要求时启用；MVP 可不启用，便于快速接入

## 7. 配置与环境
- 前端：
  - `API_BASE`：接口域名（如 `https://api.example.com`）
  - 允许通过查询参数 `api` 覆盖（可选）：`/index.html?sessionId=...&api=https://api...`
- 后端：
  - `CORS_ORIGINS`：允许的前端域名
  - `EXTERNAL_LINK_SECRET`：可选，用于签名

## 8. 部署
- 前端：静态托管（Nginx/CDN/OSS），URL 形如：
  - `https://frontend.example.com/simple-experiment/index.html?sessionId=...`
- 后端：公开 API（HTTPS，允许 CORS）：
  - `https://api.example.com/api/experiments/external/:id`
- 注意事项：
  - 前后端全部使用 HTTPS，避免混合内容
  - 确保路由优先级：`/external/:id` 要放在 `/:id` 动态路由前

## 9. 监控与日志
- 前端：控制台错误捕获、简单埋点（可选）
- 后端：接口访问日志、错误堆栈、慢查询（可选）

## 10. 性能与体验
- 资源体积 < 100KB（不含字体与图标），首屏 < 1s（网络良好）
- 使用浏览器缓存（静态资源加 hash）；接口合理超时（建议 5-10s）

## 11. 测试与验收标准
- 功能用例：
  - 有效 `sessionId` 返回 200 且展示完整数据
  - 无效 `sessionId` 返回 404，页面显示提示并回退示例数据
  - 空 `sessionId`：页面提示并展示示例数据
  - 大小写字段兼容：传入仅含 `SessionId/SmilePercentage` 的记录也能正确展示
- 跨域：前端域名可正常调用后端 API，无 CORS 报错
- 部署：公网可通过外链访问，不受登录限制（MVP）

## 12. 项目结构建议（两种）
- A. 纯静态实现（更轻）：
  - `index.html` + `styles.css` + `app.js`
  - 直接放静态服务器，改 `API_BASE` 即可上线
- B. 轻量框架（可扩展）：
  - Vite + React/TS，单路由应用，后续可按需扩展图表/多语

## 13. 里程碑
- M1（1 天）：静态页完成、示例数据可视化、接口对接、回退策略
- M2（0.5 天）：部署到测试环境 + CORS 配置 + 验收
- M3（可选）：签名校验/短期 JWT、安全加固

## 14. 外链规范（给上游平台）
- 页面外链：
  - `https://frontend.example.com/simple-experiment/index.html?sessionId=<SESSION_ID>`
- （可选）带签名：
  - `...&userId=<UID>&classId=<CID>&ts=<UNIX>&sig=<HMAC>`

---
**备注**：当前仓库已提供一个原型页 `client/public/simple-experiment/` 可直接作为参考或迁移到新项目。新项目创建后，将接口域名替换为线上 API 即可对外使用。 